
/**
 * changed to support multiple sensors and streams
 * control QuickTOCxy device
 **/
stateMachine(0, "control")
state(0,"stop", 0;,RED_BUTTON /* later:NO_BUTTON */)
    goIf( 0, 0==control)
    goIf( 11, true)
state(11,"check parameters",READ_PARAMETERS, 0)
    goMs( 12, 5 * 1000 )
    goIf( 12, READ_PARAMETERS_DONE)
    goIf( 0, 0==control)
state(12," - waiting", CHECK_PARAMETERS, 0)
    goMs( 25, 40 * 1000 )
    goIf( 0, 0==control)
    goIf( 25, CHECK_PARAMETERS_DONE)
state(25,"selftest", ENTRY_SELFTEST, 0)
    goMs( 26, 4 * 1000 )
    goIf( 0, 0==control)
state(26," - waiting", 0, EXIT_SELFTEST)
	goMs( 27, 150 * 1000 )
	goIf( 0, 0==control)
	goIf( 27, SELFTEST_DONE) // SELFTEST_DONE
state(27,"gui-process", 0, 0)
	goMs( 28, 10 * 1000 )
	goIf( 0, 0==control)
state(28," - waiting", 0, 0)
	goIf( 35,35==control)
	goIf( 0, 0==control)
	goMs( 35,60*1000 )
state(35,"read parameters", READ_ALL_PARAMETERS,0)
    goMs( 36,3 * 1000 )
    goIf( 36,READ_ALL_PARAMETERS_DONE) // falling edge
    goIf( 0, 0==control)
state(36," - waiting", 0, 0)
    goMs( 40, 300 * 1000 )
    goIf( 0, 0==control)
    goIf( 40, READ_ALL_PARAMETERS_DONE)
state(40,"initializing", ALL_INITIALIZE;SET_HOLD_POS_DONE(0),0)
	goMs( 42, 300 )
	goIf( 0, 0==control)
state(42," -  more",NO_BUTTON;ALL_BREAK;ALL_STD;SET_RETRY(0);SET_GO_TO_HOLD(1);SET_HOLD_POS_DONE(0),0)
	goMs( 59, 300 )
	goIf( 0, 0==control)
	goIf(59,true)
state(59," - finish",SET_GO_TO_HOLD(0);SET_HOLD_POS_DONE(1);RED_BUTTON;SET_WARTUNG(0),0)
	goIf(90, true)
state(90,"warming up", BUTTON_IS_AUTOSTART;ENTRY_STANDBY;,0)
    goIf( 0, 0==control)
    goIf( 21, 21==control)
    goIf(6000, WARTUNG )
    goIf(1000, 1000==control)
    goIf(1010, 1010==control)
    goIf(2000, 2000==control)
    goIf(3000, 3000==control)
    goIf(3100, 3100==control)
    goIf(3500, 3500==control)
    goIf(5000, 5000==control)
    goIf(5009, 5009==control)
    goIf(5100, 5100==control)
    goIf(5200, 5200==control)
    goIf(5500, 5500==control)
    goIf(5510, 5510==control)
    goIf(5520, 5520==control)
    goIf(5600, 5600==control)
    goIf(6000, 6000==control)
    goIf(7000, 7000==control)
    goIf(1020, EMERGENCY_FURNACE)
    goIf(1025, EMERGENCY_HUMIDITY)
    goIf(1035, TEMPERATURE_MONITORING_MAX)
    goIf( 100, WARMING_UP_DONE)
state(100,"operational",ENTRY_OPERATIONAL, EXIT_OPERATIONAL)
	goIf(1025, EMERGENCY_HUMIDITY)
	goIf(1025, EMERGENCY_HUMIDITY)
	goIf(2000, STARTUP_IS_MEASUREMENT)
	goIf(1000, true)
state(1000,"standby", WRITE_STARTUP_FLAGS_IF_CHANGED(0);ENTRY_STANDBY;GREEN_BUTTON;ENTRY_OFFLINE;TEMPERATURE_MONITORING_REPAIR,0)
    goIf( 0, 0==control)
    goIf( 21, 21==control)
    goIf(6000, WARTUNG )
    goIf(1000, 1000==control)
    goIf(1010, 1010==control)
    goIf(2000, 2000==control)
    goIf(3000, 3000==control)
    goIf(3090, 3090==control)
    goIf(3100, 3100==control)
    goIf(3500, 3500==control)
    goIf(4000, 4000==control)
    goIf(5000, 5000==control)
    goIf(5050, 5050==control)
    goIf(5009, 5009==control)
    goIf(5100, 5100==control)
    goIf(5200, 5200==control)
    goIf(5500, 5500==control)
    goIf(5510, 5510==control)
    goIf(5520, 5520==control)
    goIf(5600, 5600==control)
    goIf(6000, 6000==control)
    goIf(7000, 7000==control)
    goIf(90  , 0==WARMING_UP_DONE)
state(1010,"inactivating device", RED_BUTTON;ALL_INACTIVE,ALL_INITIALIZE;)
	goIf( 0, 0==control)
	goIf(1000, 1000==control)
	goIf(6000, 6000==control)
state(1020,"furnace emergency hold", RED_BUTTON;EMERGENCY_STD;FURNACE_OFF, 0)
	goIf( 0, 0==control)
	goIf(1025, EMERGENCY_HUMIDITY)
    goIf(1035, TEMPERATURE_MONITORING_MAX)
	goIf(1000, 1000==control)
	goIf(6000, 6000==control)
state(1025,"humidity emergency hold", RED_BUTTON;EMERGENCY_STD;Y1,0)
	goIf( 0, 0==control)
    goIf(1020, EMERGENCY_FURNACE)
    goIf(1035, TEMPERATURE_MONITORING_MAX)
	goIf(1000, 1000==control)
	goIf(6000, 6000==control)
state(1035,"temperature max emergency hold", RED_BUTTON;EMERGENCY_STD;FURNACE_OFF,TEMPERATURE_MONITORING_REPAIR)
	goIf( 0, 0==control)
	goIf(1025, EMERGENCY_HUMIDITY)
	goIf(1000, 1000==control)
	goIf(6000, 6000==control)
state(2000, "measurement", RED_BUTTON;ENTRY_MEASUREMENT;WRITE_STARTUP_FLAGS_IF_CHANGED(1);CONTROL_TIMER_RESTART;,ENTRY_ONLINE;)
    goIf( 90, 0==WARMING_UP_DONE)
	goIf(1000, 1000==control)
	goIf(2002,STREAM==0)
    goIf(2001, true)
state( 2001 , " - online check",0,0)
	goIf( 90, 0==WARMING_UP_DONE)
	goIf(1000, 1000==control)
	goIf(2020, IS_START_ONLINE_STREAM)
	goIf(2003, true)
state(2002, " - next run",NEXT_RUN, 0)
	goIf(2020, WAITING_FOR_VALUE) // change pos go to y hold IS_RINSING (sascha)
	goIf(2003, CALIBRATION)
	goIf(1000, SINGLE_MEASUREMENT)
	goIf(2003, true)
state(2003, " - waiting", SET_NEW_SOLUTION(0);EXIT_CHECK;SET_MESSBEREICH_UMSCHALTEN(0);SET_NEXT_SIGNAL_STREAM,SET_ACTIVE_STREAM;)
	goIf(C_RINSE_HS,NEED_HS_RINSING)
	goIf(3200, NEED_VALIDIERUNG)
	goIf(3100, NEED_AUTOCALIBRATION)
	goIf(2008, NEED_CHECK)
	goIf(3091, CALIBRATION && 0==STREAM && AUTOCALIBRATION)
	goIf(3010, CALIBRATION && 0==STREAM)
	goIf(2017, CALIBRATION)
	goIf(2020, 0!=TIC/*|| FIRST_STREAM!=STREAM*/)
	goIf(2009, 0!=WAITING_FOR_NEXT_MEASUREMENT_NEW)
	goIf(  90, 0==WARMING_UP_DONE)
	goIf(1000, 1000==control)
state(2004, " - waiting", SET_MESSBEREICH_UMSCHALTEN(0);SET_OLD_SIGNAL_STREAM,SET_ACTIVE_STREAM;SET_MESSBEREICH_STREAM(STREAM))
    goIf(C_RINSE_HS,NEED_HS_RINSING)
	goIf(3100, NEED_AUTOCALIBRATION)
	goIf(2008, NEED_CHECK)
	goIf(3091, CALIBRATION && 0==STREAM && AUTOCALIBRATION)
	goIf(3010, CALIBRATION && 0==STREAM)
	goIf(2017, CALIBRATION)
	goIf(2020, 0!=TIC/*|| FIRST_STREAM!=STREAM*/)
	goIf(2009, 0!=WAITING_FOR_NEXT_MEASUREMENT_NEW)
	goIf(  90, 0==WARMING_UP_DONE)
	goIf(1000, 1000==control)
state(2008,"check",ENTRY_CHECK;RED_BUTTON;SET_HOLD_POS_DONE(0),0)
	goIf(  90, 0==WARMING_UP_DONE)
	goIf(1000, 1000==control)
	goIf(2009, true)
state(2009, " - interval", 0, 0)
	goIf(1000, 1000==control)
	goIf(1000,SINGLE_MEASUREMENT)
	goIf(2020, true)
state(2010, " - error retry", ALL_BREAK;ALL_STD;SET_RETRY(1+RETRY);SET_RINSING(1);,SET_HOLD_POS_DONE(0))
    goIf( 90, 0==WARMING_UP_DONE)
	goIf(1000, 1000==control)
	goIf_error(1000, RETRY>3)
	goMs(2020, 60*1000)
state(2017," - solution wait",0,SET_NEW_SOLUTION(0))
	goIf(2018,IS_NEW_SOLUTION && (!IS_GAS_CALIBRATION) )
	goMs(2020,2000);
state(2018," - solution waiting",SET_CONTROL_SOLUTION_USER(1),SET_CONTROL_SOLUTION_USER(0))
	goIf( 90, 0==WARMING_UP_DONE)
	goIf(2020, 2020==control)
	goIf(3010, 1000==control)
state(2020, " - initializing", if(!MULTIPLE_MEASUREMENT) NEXT_MEASUREMENT;SET_TIC_IS_ONLY; ALL_STD;, 0)
	goIf(1000, 1000==control)
	goIf(2085, VALIDIERUNG )
	goIf(2070, IS_NEED_GAS_CLEANUP && !WAITING_FOR_VALUE )
	goIf(2085, (IS_GAS_CALIBRATION && CALIBRATION))
	goIf(2030, true)
state(2030," - rinsing", PRINT_RINSING, 0)
	goIf(1000, 1000==control)
	goIf(2032, IS_PRE_RINSING)
	goIf(2057, true)
state(2032," - start pre-rinsing", GP10_ON;Y3Y10_NC;,GP10_STD;Y3Y10_NO )
	goIf(1000, 1000==control)
	goMs(2057,( 0 < pre_rinsing_time(STREAM) ) ? 1000 * pre_rinsing_time(STREAM) : 100)
state(2057," - rinsing done",SET_RINSING(0);,0)
	goIf (2058, true)
state(2058," - delay",  ms_startTimer_Delay( 1000 * DELAY ), 0)
    goIf( 90, 0==WARMING_UP_DONE)
	goIf(1000, 1000==control)
	go_timeout_Delay(2059)
state(2059," - filling decision", 0, 0)
	goIf (2060, TOC_DIRECT_METHOD && (!CALIBRATION) && (!SINGLE_MEASUREMENT_WITH_CAL) )
	goIf (2110, true)
state(2060," - filling sample vessel", GP_FULL(STREAM);, GP_INACTIVE(STREAM);)
    goIf(C_RINSE_SHUTDOWN, 0==WARMING_UP_DONE)
	goIf(C_RINSE_SHUTDOWN, 1000==control)
	goMs(2110, ( 0 < sample_vessel_filling(STREAM) ) ? 1000 * sample_vessel_filling(STREAM) : 1000) // try 0 sec to reduce sample consumption
// Gas Calibration rinsing system
state(2070," - rinsing",SET_GAS_CLEANUP_REPL(0);SET_GAS_CLEANUP_STATUS(FALSE);Y4Y5_NC;Y4Y6_NC;,Y4Y5_NO;Y4Y6_NO)
	goIf(C_RINSE_SHUTDOWN, 0==WARMING_UP_DONE)
	goIf(C_RINSE_SHUTDOWN, 1000==control)
	goMs(2072, ( 0 < purge_time_gasmeasurement(STREAM) ) ? 1000 * purge_time_gasmeasurement(STREAM) : 5000)
state(2072," - rinsing done",0,0)
	goIf(C_RINSE_SHUTDOWN, 0==WARMING_UP_DONE)
	goIf(C_RINSE_SHUTDOWN, 1000==control)
	goIf(2085, VALIDIERUNG )
	goIf(2074, true)
state(2074," - cleanup ",SET_GAS_CLEANUP_REPL(GAS_CLEANUP_REPL+1);,LOOP_BLOCK_WAIT)
	goIf(C_RINSE_SHUTDOWN, 0==WARMING_UP_DONE)
	goIf(C_RINSE_SHUTDOWN, 1000==control)
	goIf(2080, GAS_CLEANUP_REPL>cleanup_repetitions(STREAM))
	goIf(2078, true)
state(2078," - wait cleanup loop",LOOP_BLOCK_WAIT;,0)
	goIf(C_RINSE_SHUTDOWN, 0==WARMING_UP_DONE)
	goIf(C_RINSE_SHUTDOWN, 1000==control)
	goMs(2079,  ( 0 < cleanup_time(STREAM) ) ? 1000 * cleanup_time(STREAM) : 1000)
state(2079," - wait cleanup furnace",LOOP_BLOCK_ONLINE;,0)
	goIf(C_RINSE_SHUTDOWN, 0==WARMING_UP_DONE)
	goIf(C_RINSE_SHUTDOWN, 1000==control)
	goMs(2074,  ( 0 < cleanup_time(STREAM) ) ? 1000 * cleanup_time(STREAM) : 1000)
state(2080," - cleanup done",SET_GAS_CLEANUP_REPL(0);SET_GAS_CLEANUP_STATUS(FALSE);LOOP_BLOCK_WAIT;,0)
	goIf(C_RINSE_SHUTDOWN,  0==WARMING_UP_DONE)
	goIf(C_RINSE_SHUTDOWN, 1000==control)
	goMs(2110, 180000)
state(2085," - gas delay",0,0)
	goIf(C_RINSE_SHUTDOWN,  0==WARMING_UP_DONE)
	goIf(C_RINSE_SHUTDOWN, 1000==control)
	goMs(2110, 10000)
state (2110 , " - need stripping ",0,0)
	goIf(C_RINSE_SHUTDOWN, 0==WARMING_UP_DONE)
	goIf(C_RINSE_SHUTDOWN, 1000==control)
	goIf(2130, VALIDIERUNG)
	goIf(2130, SINGLE_MEASUREMENT_WITH_CAL )
	goIf(2115, (TOC_DIRECT_METHOD && (!CALIBRATION)) )
	goIf(2130, true)
state (2115," - TOC-direct get acid",Y5Y9_NC;ACID_ON(STREAM);,ACID_OFF(STREAM);Y5Y9_NO)
	goIf(C_RINSE_SHUTDOWN, 0==WARMING_UP_DONE)
	goIf(C_RINSE_SHUTDOWN, 1000==control)
	goMs(2120, (0 < fill_acid_time(STREAM)) ? 1000 * fill_acid_time(STREAM) : 1000)
state(2120, " - TOC-direct stripping",Y5Y9_NC;ACID_ON(STREAM);Y6Y1_NC;,ACID_OFF(STREAM);Y5Y9_NO;Y6Y1_NO;)
	goIf(C_RINSE_SHUTDOWN, 0==WARMING_UP_DONE)
	goIf(C_RINSE_SHUTDOWN, 1000==control)
	goMs(2130, (0 < control_STRIPPING(STREAM)) ? 1000 * control_STRIPPING(STREAM) : 100)
state(2130, " - justification start", ENTRY_JUSTIFICATION;SET_ONLY_GASFLOW(0);,EXIT_JUSTIFICATION;)
	goIf(C_RINSE_SHUTDOWN, 0==WARMING_UP_DONE)
	goIf(C_RINSE_SHUTDOWN, 1000==control)
	goIf(2140, DONE_JUSTIFICATION)
state(2140, " - justification done",0 ,0)
	goIf(2220, VALIDIERUNG)
	goIf(2220, (IS_GAS_CALIBRATION && (CALIBRATION)) )
	goIf(2200, true)
state(2200," - prepare loop solution system",TUBING_ON(STREAM);GP10_ON;,GP10_INACTIVE;)
	goIf(C_RINSE_SHUTDOWN, 0==WARMING_UP_DONE)
	goIf(C_RINSE_SHUTDOWN, 1000==control)
	goMs(2220, ( 0 < prepare_loop_system(STREAM) ) ? 1000 * prepare_loop_system(STREAM) : 1000) // try 0 sec to reduce sample consumption
state(2220," - prepare analysing",SET_CALIBRATION_AIRFLOW;,0)
	goIf(C_RINSE_SHUTDOWN, 0==WARMING_UP_DONE)
	goIf(C_RINSE_SHUTDOWN, 1000==control)
	goMs(2300, 100)
state(2300," - analysing",ENTRY_ANALYSING;,SET_RETRY_LOOP_INJECTION(0))
	goIf(C_RINSE_SHUTDOWN, 0==WARMING_UP_DONE)
	goIf(C_RINSE_SHUTDOWN, 1000==control)
	goIf(2320, true)
state(2320," - analysing wait ingection",SET_RETRY_LOOP_INJECTION(RETRY_LOOP_INJECTION+1),0)
	goIf(C_RINSE_SHUTDOWN, 0==WARMING_UP_DONE)
	goIf(C_RINSE_SHUTDOWN, 1000==control)
	goIf(2390, loop_injection_done())
	goIf(2380, VALIDIERUNG)
	goIf(2380, (IS_GAS_CALIBRATION && (CALIBRATION)) )
	goIf(2325, true)
state(2325," - loop prepare",0,0)
	goIf(C_RINSE_SHUTDOWN, 0==WARMING_UP_DONE)
	goIf(C_RINSE_SHUTDOWN, 1000==control)
	goIf(2330, true)
state(2330," - injection process fill loop system",TUBING_ON(STREAM);GP10_ON;,GP10_INACTIVE;)
	goIf(C_RINSE_SHUTDOWN, 0==WARMING_UP_DONE)
	goIf(C_RINSE_SHUTDOWN, 1000==control)
	goMs(2332, ( 0 < fill_loop_system_time(STREAM) ) ? 1000 * fill_loop_system_time(STREAM) : 5000)
state(2332," - wait befor injection ",0,0)
	goIf(C_RINSE_SHUTDOWN, 0==WARMING_UP_DONE)
	goIf(C_RINSE_SHUTDOWN, 1000==control)
	goMs(2335, ( 0 < waite_befor_injection_time(STREAM) ) ? 1000 * waite_befor_injection_time(STREAM) : 500)
state(2335," - injection process",0,0)
	goIf(C_RINSE_SHUTDOWN, 1000==control)
	goIf( TIC  ? 2370  : 2350, true)
state(2350," - injection process TC",LOOP_BLOCK_ONLINE;Y4Y7_NO;,LOOP_BLOCK_WAIT;)
	goIf(C_RINSE_SHUTDOWN, 0==WARMING_UP_DONE)
	goIf(C_RINSE_SHUTDOWN, 1000==control)
	goMs(2320, ( 0 < injection_loop_time(STREAM) ) ? 1000 * injection_loop_time(STREAM) : 5000 )
state(2370," - injection process TIC",Y4Y7_NC;LOOP_BLOCK_ONLINE,LOOP_BLOCK_WAIT;Y4Y7_NO )
	goIf(C_RINSE_SHUTDOWN, 0==WARMING_UP_DONE )
	goIf(C_RINSE_SHUTDOWN, 1000==control )
	goMs( 2320, ( 0 < injection_loop_time(STREAM) ) ? 1000 * injection_loop_time(STREAM) : 5000 )
state(2380," - injection process fill gas",FILL_GAS,Y4Y5_NO;Y4Y6_NO;)
	goIf(C_RINSE_SHUTDOWN,  0==WARMING_UP_DONE)
	goIf(C_RINSE_SHUTDOWN, 1000==control)
	goMs(2382, ( 0 < mkIget(parameter___LoopGasFillTime) ) ? 1000 * mkIget(parameter___LoopGasFillTime) : 5000)
state(2382," - injection process gas",FILL_GAS;LOOP_BLOCK_ONLINE;,LOOP_BLOCK_WAIT;Y4Y5_NO;Y4Y6_NO;)
	goIf(C_RINSE_SHUTDOWN,  0==WARMING_UP_DONE)
	goIf(C_RINSE_SHUTDOWN, 1000==control)
	goMs(2320, ( 0 < mkIget(parameter___LoopGasInjectionTime) ) ? 1000 * mkIget(parameter___LoopGasInjectionTime) : 5000)
state(2390," - analysing air flow",startTimer_ai(5000),stopTimer_ai())
	goIf(C_RINSE_SHUTDOWN,  0==WARMING_UP_DONE)
	goIf(C_RINSE_SHUTDOWN, 1000==control)
	goIf(2400, anylyse_injection_done())
state(2400, " - analysing process",0 ,TUBING_OFF(STREAM);)
	goIf(C_RINSE_SHUTDOWN, 0==WARMING_UP_DONE)
	goIf(C_RINSE_SHUTDOWN, 1000==control)
	goIf(2420, VALIDIERUNG)
	goIf(2420, CALIBRATION)
	goIf(2420, SINGLE_MEASUREMENT_WITH_CAL)
	goIf(2410, (TOC_DIRECT_METHOD))
	goIf(2415, true)
state(2410, " - rinse vessel", Y3Y10_NO;TUBING_ON(STREAM);GP10_FAST;,TUBING_OFF(STREAM);GP10_STD;)
	goIf(C_RINSE_SHUTDOWN, 0==WARMING_UP_DONE)
	goIf(C_RINSE_SHUTDOWN, 1000==control)
	goMs(2415, ( 0 < rinsing_loop_time(STREAM) ) ? 1000 * rinsing_loop_time(STREAM) : 5000)
state(2415, " - rinse system",0,0)
	goIf(2417, IS_RINSING_ON)
	goIf(2418, true)
state(2417," - start rinsing", Y3Y10_NC;GP10_ON;,GP10_STD;Y3Y10_NO )
	goIf(1000, 1000==control)
	goMs(2418,( 0 < rinsing_time(STREAM) ) ? 1000 * rinsing_time(STREAM) : 100)
state(2418, " - rinsing done",SET_RINSING(0);,0)
	goIf (2420, true)
state(2420, " - analysing",0 ,EXIT_ANALYSING;)
	goIf( 90, 0==WARMING_UP_DONE)
	goIf(1000, 1000==control)
	goMs(2430, 900 * 1000)
	goIf(2430,DONE_ANALYSING)
state(2430, " - analysing done", 0,0)
	goMs(2440, 1 * 1000)
state(2440, " - go to next run", 0,0)
	goIf(2480, (COMPARE && !WAITING_FOR_VALUE))
	goIf(2490, (VALIDIERUNG && !WAITING_FOR_VALUE))
	goIf(2002, true)
state(2480, "measurement", 0,EXIT_CHECK)
	goIf(2002, true)
state(2490, "measurement", 0,EXIT_VALIDIERUNG)
	goIf(2002, true)
state(3000,"calibration", RED_BUTTON;ENTRY_CALIBRATION;SET_HOLD_POS_DONE(0), 0)
    goIf( 90, 0==WARMING_UP_DONE)
    goIf( 90, 0==STREAM)
	goIf(1000, 1000==control)
    goIf(2020, true)
state(3010,"calibration done",EXIT_CALIBRATION,0;)
	goMs(1000,3000)
state(3090,"activate calibration", ENTRY_ACTIVATE_CALIBRATION,0)
	goMs(1000, 3000)
state(3091,"calculate autocalibration outliers", CALCULATE_AUTO_CALIBRATION_OUTLIERS,0)
	goMs(3094, 3000)
state(3094,"activate autocalibration", ENTRY_ACTIVATE_AUTOCALIBRATION,EXIT_AUTO_CALIBRATION;END_MEASUREMENT_PROGRESS)
	goMs(3095, 3000)
state(3095,"measurement",RED_BUTTON;ENTRY_MEASUREMENT;WRITE_STARTUP_FLAGS_IF_CHANGED(1);,SET_RINSING(1);)
   	goIf(2003,true)
state(3100,"autocalibration", ENTRY_AUTO_CALIBRATION;RED_BUTTON;SET_HOLD_POS_DONE(0),0)
    goIf( 90, 0==WARMING_UP_DONE)
    goIf(1000, 1000==control)
    goIf(2020, true)
state(3200,"validation", ENTRY_VALIDIERUNG;RED_BUTTON;,0)
    goIf( 90, 0==WARMING_UP_DONE)
    goIf(1000, 1000==control)
    goIf(2020, true)
state(3500,"save calibrations parameter", NO_BUTTON, 0)
	goIf( 3501,true )
state(3501," - waiting", ENTRY_SAVE_CALIBRATIONS_PARAMETER, 0)
	goMs(1000, 15*1000 )
	goIf(1000, SAVE_CALIBRATIONS_PARAMETER_DONE)
state(4000,"single measurement", RED_BUTTON;ENTRY_SINGLE_MEASUREMENT;SET_HOLD_POS_DONE(0), 0)
	goIf( 90, 0==WARMING_UP_DONE)
	goIf(1000,IS_SINGLE_STREAM_ERROR)
	goIf(1000, 1000==control)
    goIf(2020, true)
state(5000,"all default", SET_RETRY(0);RED_BUTTON;ALL_INITIALIZE;ALL_STD;SET_GO_TO_HOLD(1);SET_HOLD_POS_DONE(0),SET_WARTUNG(0))
   	goIf(1000, true)
state(C_RINSE_SHUTDOWN," - check if need rinse",ALL_STD;EXIT_ANALYSING;,0)
	goIf(C_RINSE_SHUTDOWN+5, (TOC_DIRECT_METHOD && (!CALIBRATION)))
	goIf(C_RINSE_SHUTDOWN+10, IS_RINSING_ON && !(CALIBRATION&&IS_GAS_CALIBRATION))
	goIf(C_RINSE_SHUTDOWN+12, true)
state(C_RINSE_SHUTDOWN+5, " - rinse vessel",Y3Y10_NO;TUBING_ON(STREAM);GP10_FAST;,TUBING_OFF(STREAM);GP10_STD;)
	goIf(1000, 1000==control)
	goMs(C_RINSE_SHUTDOWN+10, ( 0 < rinsing_loop_time(STREAM) ) ? 1000 * rinsing_loop_time(STREAM) : 5000)
state(C_RINSE_SHUTDOWN+10," - rinse system ",Y3Y10_NC;GP10_ON;,GP10_STD;Y3Y10_NO )
	goIf(1000, 1000==control)
	goMs(C_RINSE_SHUTDOWN+12,( 0 < rinsing_time(STREAM) ) ? 1000 * rinsing_time(STREAM) : 100)
state(C_RINSE_SHUTDOWN+12," - rinse done",0,0)
	goIf( 90, 0==WARMING_UP_DONE)
	goIf(1000, true)
state(5100," - rinse sample tubes",RED_BUTTON;TUBING_ON(SINGLE_STREAM);GP_FULL(SINGLE_STREAM);GP10_ON;,GP_INACTIVE(SINGLE_STREAM);GP10_INACTIVE;NO_BUTTON;TUBING_OFF(SINGLE_STREAM);)
	goIf(1000, IS_SINGLE_STREAM_ERROR)
	goMs(1000, WAIT_RINSING_SAMPLE)
	goIf(6000, (1000==control&& WARTUNG) )
	goIf(1000, 1000==control )
state(C_RINSE_HS, "HS rinsing",ALL_STD;SET_HS_RINSING(1);,SET_RETRY_LOOP_INJECTION(0);)
	goIf(C_RINSE_SHUTDOWN, 0==WARMING_UP_DONE)
	goIf(C_RINSE_SHUTDOWN, 1000==control)
	goIf(C_RINSE_HS+5, true)
state(C_RINSE_HS+5,"  - prepare loop system",Y3Y10_NC;GP10_FAST;LOOP_BLOCK_WAIT;,GP10_STD;)
	goIf(C_RINSE_SHUTDOWN, 0==WARMING_UP_DONE)
	goIf(C_RINSE_SHUTDOWN, 1000==control)
	goMs(C_RINSE_HS+10,10*1000)
state(C_RINSE_HS+10,"  - wait ingection",0,SET_RETRY_LOOP_INJECTION(RETRY_LOOP_INJECTION+1))
	goIf(C_RINSE_SHUTDOWN, 0==WARMING_UP_DONE)
	goIf(C_RINSE_SHUTDOWN, 1000==control)
	goIf(C_RINSE_HS+50,HS_RINSING_INJECTION_DONE)
	goIf(C_RINSE_HS+15, true)
state(C_RINSE_HS+15," - fill loop system",GP10_FAST;LOOP_BLOCK_WAIT;,GP10_STD;)
	goIf(C_RINSE_SHUTDOWN, 0==WARMING_UP_DONE)
	goIf(C_RINSE_SHUTDOWN, 1000==control)
	goMs(C_RINSE_HS+20, 2*1000)
state(C_RINSE_HS+20," - injection",LOOP_BLOCK_ONLINE;Y4Y7_NO;,LOOP_BLOCK_WAIT;)
	goIf(C_RINSE_SHUTDOWN, 0==WARMING_UP_DONE)
	goIf(C_RINSE_SHUTDOWN, 1000==control)
	goMs(C_RINSE_HS+10, 10*1000 )
state(C_RINSE_HS+50," - waiting",GP10_STD;Y3Y10_NO;,SET_RETRY_LOOP_INJECTION(0);)
	goIf(C_RINSE_SHUTDOWN, 0==WARMING_UP_DONE)
	goIf(C_RINSE_SHUTDOWN, 1000==control)
	goMs(C_RINSE_HS+55, 120*1000 )
state(C_RINSE_HS+55,"measurement",SET_HS_RINSING(0);,RED_BUTTON;ENTRY_MEASUREMENT;WRITE_STARTUP_FLAGS_IF_CHANGED(1);SET_RINSING(1);)
	goIf(C_RINSE_SHUTDOWN, 0==WARMING_UP_DONE)
	goIf(C_RINSE_SHUTDOWN, 1000==control)
	goIf(2003,true)
state(5500," - inactivating furnace", FURNACE_OFF,0)
	goIf(1000, 1000==control)
	goMs(1000, 2*1000)
state(5501," - activating furnace", FURNACE_ON,0)
	goIf(1000, 1000==control)
	goMs(1000, 2*1000)
state(5510," - inactivating condensat pumpe", GP1_INACTIVE ,0)
	goIf(1000, true)
state(5511," - activating condensat pumpe", GP1_STD ,0)
	goIf(1000, true)
state(5600," - calibrate airflow in-out",ENTRY_CALIBRATE_AIRFLOW;,EXIT_CALIBRATE_AIRFLOW;)
	goMs(1000, 1000*20)
	goIf(1000, 1000==control)
state(6000,"wartung",ENTRY_WARTUNG;NO_BUTTON;,0)
	goIf(1000, 1000==control)
	goIf(4000, 4000==control)
	goIf(5000, 5000==control)
	goIf(5009, 5009==control)
	goIf(5050, 5050==control)
	goIf(5100, 5100==control)
	goIf(5200, 5200==control)
	goIf(5500, 5500==control)
	goIf(5501, 5501==control)
	goIf(5510, 5510==control)
	goIf(5511, 5511==control)
	goIf(5600, 5600==control)
	goIf(7000, 7000==control)
state(7000,"Set all calibration parameter for user and save it",0,0)
	goMs(3500, 1000*15)
stateMachineEnd
//
